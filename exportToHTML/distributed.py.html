<html>
<head>
<title>distributed.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
distributed.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright 2021 The JAX Authors.</span>
<span class="s0">#</span>
<span class="s0"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0"># you may not use this file except in compliance with the License.</span>
<span class="s0"># You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0"># Unless required by applicable law or agreed to in writing, software</span>
<span class="s0"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0"># See the License for the specific language governing permissions and</span>
<span class="s0"># limitations under the License.</span>

<span class="s2">import </span><span class="s1">atexit</span>
<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">os</span>

<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Optional</span><span class="s2">, </span><span class="s1">Union</span><span class="s2">, </span><span class="s1">Sequence</span>

<span class="s2">from </span><span class="s1">jax._src </span><span class="s2">import </span><span class="s1">clusters</span>
<span class="s2">from </span><span class="s1">jax._src.config </span><span class="s2">import </span><span class="s1">config</span>
<span class="s2">from </span><span class="s1">jax._src.lib </span><span class="s2">import </span><span class="s1">xla_extension</span>

<span class="s1">logger = logging.getLogger(__name__)</span>


<span class="s2">class </span><span class="s1">State:</span>
  <span class="s1">process_id: int = </span><span class="s3">0</span>
  <span class="s1">service: Optional[Any] = </span><span class="s2">None</span>
  <span class="s1">client: Optional[Any] = </span><span class="s2">None</span>
  <span class="s1">preemption_sync_manager: Optional[Any] = </span><span class="s2">None</span>
  <span class="s1">coordinator_address: Optional[str] = </span><span class="s2">None</span>

  <span class="s2">def </span><span class="s1">initialize(self</span><span class="s2">,</span>
                 <span class="s1">coordinator_address: Optional[str] = </span><span class="s2">None,</span>
                 <span class="s1">num_processes: Optional[int] = </span><span class="s2">None,</span>
                 <span class="s1">process_id: Optional[int] = </span><span class="s2">None,</span>
                 <span class="s1">local_device_ids: Optional[Union[int</span><span class="s2">, </span><span class="s1">Sequence[int]]] = </span><span class="s2">None</span><span class="s1">):</span>
    <span class="s1">coordinator_address = (coordinator_address </span><span class="s2">or</span>
                           <span class="s1">os.environ.get(</span><span class="s4">'JAX_COORDINATOR_ADDRESS'</span><span class="s2">, None</span><span class="s1">))</span>
    <span class="s2">if </span><span class="s1">isinstance(local_device_ids</span><span class="s2">, </span><span class="s1">int):</span>
      <span class="s1">local_device_ids = [local_device_ids]</span>

    <span class="s1">(coordinator_address</span><span class="s2">, </span><span class="s1">num_processes</span><span class="s2">, </span><span class="s1">process_id</span><span class="s2">, </span><span class="s1">local_device_ids) = (</span>
        <span class="s1">clusters.ClusterEnv.auto_detect_unset_distributed_params(</span>
            <span class="s1">coordinator_address</span><span class="s2">, </span><span class="s1">num_processes</span><span class="s2">, </span><span class="s1">process_id</span><span class="s2">, </span><span class="s1">local_device_ids</span>
        <span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s2">if </span><span class="s1">coordinator_address </span><span class="s2">is None</span><span class="s1">:</span>
      <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">'coordinator_address should be defined.'</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">num_processes </span><span class="s2">is None</span><span class="s1">:</span>
      <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">'Number of processes must be defined.'</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">process_id </span><span class="s2">is None</span><span class="s1">:</span>
      <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">'The process id of the current process must be defined.'</span><span class="s1">)</span>

    <span class="s1">self.coordinator_address = coordinator_address</span>

    <span class="s2">if </span><span class="s1">local_device_ids:</span>
      <span class="s1">visible_devices = </span><span class="s4">','</span><span class="s1">.join(str(x) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">local_device_ids) </span><span class="s0"># type: ignore[union-attr]</span>
      <span class="s1">logger.info(</span><span class="s4">'JAX distributed initialized with visible devices: %s'</span><span class="s2">, </span><span class="s1">visible_devices)</span>
      <span class="s1">config.update(</span><span class="s4">&quot;jax_cuda_visible_devices&quot;</span><span class="s2">, </span><span class="s1">visible_devices)</span>
      <span class="s1">config.update(</span><span class="s4">&quot;jax_rocm_visible_devices&quot;</span><span class="s2">, </span><span class="s1">visible_devices)</span>

    <span class="s1">self.process_id = process_id</span>

    <span class="s2">if </span><span class="s1">process_id == </span><span class="s3">0</span><span class="s1">:</span>
      <span class="s2">if </span><span class="s1">self.service </span><span class="s2">is not None</span><span class="s1">:</span>
        <span class="s2">raise </span><span class="s1">RuntimeError(</span><span class="s4">'distributed.initialize should only be called once.'</span><span class="s1">)</span>
      <span class="s1">logger.info(</span><span class="s4">'Starting JAX distributed service on %s'</span><span class="s2">, </span><span class="s1">coordinator_address)</span>
      <span class="s1">self.service = xla_extension.get_distributed_runtime_service(</span>
          <span class="s1">coordinator_address</span><span class="s2">, </span><span class="s1">num_processes</span><span class="s2">, </span><span class="s1">config.jax_coordination_service)</span>

    <span class="s2">if </span><span class="s1">self.client </span><span class="s2">is not None</span><span class="s1">:</span>
      <span class="s2">raise </span><span class="s1">RuntimeError(</span><span class="s4">'distributed.initialize should only be called once.'</span><span class="s1">)</span>

    <span class="s0"># Set init_timeout to 5 min to leave time for all the processes to connect</span>
    <span class="s1">self.client = xla_extension.get_distributed_runtime_client(</span>
        <span class="s1">coordinator_address</span><span class="s2">, </span><span class="s1">process_id</span><span class="s2">, </span><span class="s1">config.jax_coordination_service</span><span class="s2">,</span>
        <span class="s1">init_timeout=</span><span class="s3">300</span><span class="s1">)</span>
    <span class="s1">logger.info(</span><span class="s4">'Connecting to JAX distributed service on %s'</span><span class="s2">, </span><span class="s1">coordinator_address)</span>
    <span class="s1">self.client.connect()</span>

    <span class="s2">if </span><span class="s1">config.jax_coordination_service:</span>
      <span class="s1">self.initialize_preemption_sync_manager()</span>

  <span class="s2">def </span><span class="s1">shutdown(self):</span>
    <span class="s2">if </span><span class="s1">self.client:</span>
      <span class="s1">self.client.shutdown()</span>
      <span class="s1">self.client = </span><span class="s2">None</span>
    <span class="s2">if </span><span class="s1">self.service:</span>
      <span class="s1">self.service.shutdown()</span>
      <span class="s1">self.service = </span><span class="s2">None</span>
    <span class="s2">if </span><span class="s1">self.preemption_sync_manager:</span>
      <span class="s1">self.preemption_sync_manager = </span><span class="s2">None</span>

  <span class="s2">def </span><span class="s1">initialize_preemption_sync_manager(self):</span>
    <span class="s2">if </span><span class="s1">self.preemption_sync_manager </span><span class="s2">is not None</span><span class="s1">:</span>
      <span class="s2">raise </span><span class="s1">RuntimeError(</span>
          <span class="s4">'Preemption sync manager should only be initialized once.'</span><span class="s1">)</span>
    <span class="s1">self.preemption_sync_manager = (</span>
        <span class="s1">xla_extension.create_preemption_sync_manager())</span>
    <span class="s1">self.preemption_sync_manager.initialize(self.client)</span>

<span class="s1">global_state = State()</span>


<span class="s2">def </span><span class="s1">initialize(coordinator_address: Optional[str] = </span><span class="s2">None,</span>
               <span class="s1">num_processes: Optional[int] = </span><span class="s2">None,</span>
               <span class="s1">process_id: Optional[int] = </span><span class="s2">None,</span>
               <span class="s1">local_device_ids: Optional[Union[int</span><span class="s2">, </span><span class="s1">Sequence[int]]] = </span><span class="s2">None</span><span class="s1">):</span>
  <span class="s5">&quot;&quot;&quot;Initializes the JAX distributed system. 
 
  Calling :func:`~jax.distributed.initialize` prepares JAX for execution on 
  multi-host GPU and Cloud TPU. :func:`~jax.distributed.initialize` must be 
  called before performing any JAX computations. 
 
  The JAX distributed system serves a number of roles: 
 
    * it allows JAX processes to discover each other and share topology information, 
    * it performs health checking, ensuring that all processes shut down if any process dies, and 
    * it is used for distributed checkpointing. 
 
  If you are using TPU, Slurm, or Open MPI, all arguments are optional: if omitted, they 
  will be chosen automatically. 
 
  Otherwise, you must provide the ``coordinator_address``, 
  ``num_processes``, and ``process_id`` arguments to :func:`~jax.distributed.initialize`. 
 
  Args: 
    coordinator_address: the IP address of process `0` and a port on which that 
      process should launch a coordinator service. The choice of 
      port does not matter, so long as the port is available on the coordinator 
      and all processes agree on the port. 
      May be ``None`` only on supported environments, in which case it will be chosen automatically. 
      Note that special addresses like ``localhost`` or ``127.0.0.1`` usually mean that the program 
      will bind to a local interface and are not suitable when running in a multi-host environment. 
    num_processes: Number of processes. May be ``None`` only on supported environments, in 
      which case it will be chosen automatically. 
    process_id: The ID number of the current process. The ``process_id`` values across 
      the cluster must be a dense range ``0``, ``1``, ..., ``num_processes - 1``. 
      May be ``None`` only on supported environments; if ``None`` it will be chosen automatically. 
    local_device_ids: Restricts the visible devices of the current process to ``local_device_ids``. 
      If ``None``, defaults to all local devices being visible to the process except when processes 
      are launched via Slurm and Open MPI on GPUs. In that case, it will default to a single device per process. 
 
  Raises: 
    RuntimeError: If :func:`~jax.distributed.initialize` is called more than once. 
 
  Example: 
 
  Suppose there are two GPU processs, and process 0 is the designated coordinator 
  with address ``10.0.0.1:1234``. To initialize the GPU cluster, run the 
  following commands before anything else. 
 
  On process 0: 
 
  &gt;&gt;&gt; jax.distributed.initialize(coordinator_address='10.0.0.1:1234', num_processes=2, process_id=0)  # doctest: +SKIP 
 
  On process 1: 
 
  &gt;&gt;&gt; jax.distributed.initialize(coordinator_address='10.0.0.1:1234', num_processes=2, process_id=1)  # doctest: +SKIP 
  &quot;&quot;&quot;</span>
  <span class="s1">global_state.initialize(coordinator_address</span><span class="s2">, </span><span class="s1">num_processes</span><span class="s2">, </span><span class="s1">process_id</span><span class="s2">, </span><span class="s1">local_device_ids)</span>
  <span class="s1">atexit.register(shutdown)</span>


<span class="s2">def </span><span class="s1">shutdown():</span>
  <span class="s5">&quot;&quot;&quot;Shuts down the distributed system. 
 
  Does nothing if the distributed system is not running.&quot;&quot;&quot;</span>
  <span class="s1">global_state.shutdown()</span>
</pre>
</body>
</html>