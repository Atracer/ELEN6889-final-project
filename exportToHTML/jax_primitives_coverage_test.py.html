<html>
<head>
<title>jax_primitives_coverage_test.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
jax_primitives_coverage_test.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright 2020 The JAX Authors.</span>
<span class="s0">#</span>
<span class="s0"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0"># you may not use this file except in compliance with the License.</span>
<span class="s0"># You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0"># Unless required by applicable law or agreed to in writing, software</span>
<span class="s0"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0"># See the License for the specific language governing permissions and</span>
<span class="s0"># limitations under the License.</span>
<span class="s2">&quot;&quot;&quot;Tests the primitive harness limitations. 
 
Runs all the harnesses surfaces the errors, and detects cases when we have 
too many or too few limitations. 
 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">collections</span>
<span class="s3">import </span><span class="s1">datetime</span>
<span class="s3">import </span><span class="s1">logging</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span><span class="s3">, </span><span class="s1">Dict</span><span class="s3">, </span><span class="s1">Sequence</span><span class="s3">, </span><span class="s1">Tuple</span>
<span class="s3">import </span><span class="s1">unittest</span>

<span class="s3">from </span><span class="s1">absl.testing </span><span class="s3">import </span><span class="s1">absltest</span>

<span class="s3">from </span><span class="s1">jax._src </span><span class="s3">import </span><span class="s1">test_util </span><span class="s3">as </span><span class="s1">jtu</span>
<span class="s3">from </span><span class="s1">jax.config </span><span class="s3">import </span><span class="s1">config</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>

<span class="s1">config.parse_flags_with_absl()</span>

<span class="s0"># Import after parsing flags</span>
<span class="s3">from </span><span class="s1">jax.experimental.jax2tf.tests </span><span class="s3">import </span><span class="s1">primitive_harness</span>


<span class="s3">class </span><span class="s1">JaxPrimitiveTest(jtu.JaxTestCase):</span>

  <span class="s0"># This test runs for all primitive harnesses. For each primitive &quot;xxx&quot; the</span>
  <span class="s0"># test will be called &quot;test_jax_implemented_xxx_...&quot;. The test harnesses,</span>
  <span class="s0"># including which dtypes are expected to fail, are defined in the</span>
  <span class="s0"># file primitive_harness.py.</span>
  <span class="s0"># If you want to run this test for only one harness, add parameter</span>
  <span class="s0"># `one_containing=&quot;foo&quot;` to parameterized below.</span>
  <span class="s1">@primitive_harness.parameterized(primitive_harness.all_harnesses</span><span class="s3">,</span>
                                   <span class="s0">#one_containing=&quot;gather_from_slicing_name&quot;,</span>
                                   <span class="s1">include_jax_unimpl=</span><span class="s3">True</span><span class="s1">)</span>
  <span class="s1">@jtu.ignore_warning(category=UserWarning</span><span class="s3">,</span>
                      <span class="s1">message=</span><span class="s4">&quot;Using reduced precision for gradient.*&quot;</span><span class="s1">)</span>
  <span class="s3">def </span><span class="s1">test_jax_implemented(self</span><span class="s3">, </span><span class="s1">harness: primitive_harness.Harness):</span>
    <span class="s2">&quot;&quot;&quot;Runs all harnesses just with JAX to verify the jax_unimplemented field. 
 
    Runs also harnesses that have jax_unimplemented but ignores their errors. 
    &quot;&quot;&quot;</span>
    <span class="s1">jax_unimpl = [l </span><span class="s3">for </span><span class="s1">l </span><span class="s3">in </span><span class="s1">harness.jax_unimplemented</span>
                  <span class="s3">if </span><span class="s1">l.filter(device=jtu.device_under_test()</span><span class="s3">,</span>
                              <span class="s1">dtype=harness.dtype)]</span>
    <span class="s3">if </span><span class="s1">any([lim.skip_run </span><span class="s3">for </span><span class="s1">lim </span><span class="s3">in </span><span class="s1">jax_unimpl]):</span>
      <span class="s1">logging.info(</span>
          <span class="s4">&quot;Skipping run with expected JAX limitations: %s in harness %s&quot;</span><span class="s3">,</span>
          <span class="s1">[u.description </span><span class="s3">for </span><span class="s1">u </span><span class="s3">in </span><span class="s1">jax_unimpl]</span><span class="s3">, </span><span class="s1">harness.fullname)</span>
      <span class="s3">return</span>
    <span class="s3">try</span><span class="s1">:</span>
      <span class="s1">harness.dyn_fun(*harness.dyn_args_maker(self.rng()))</span>
    <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">e:</span>
      <span class="s3">if </span><span class="s1">jax_unimpl:</span>
        <span class="s1">logging.info(</span>
          <span class="s4">&quot;Found expected JAX error %s with expected JAX limitations: &quot;</span>
          <span class="s4">&quot;%s in harness %s&quot;</span><span class="s3">,</span>
          <span class="s1">e</span><span class="s3">, </span><span class="s1">[u.description </span><span class="s3">for </span><span class="s1">u </span><span class="s3">in </span><span class="s1">jax_unimpl]</span><span class="s3">, </span><span class="s1">harness.fullname)</span>
        <span class="s3">return</span>
      <span class="s3">else</span><span class="s1">:</span>
        <span class="s3">raise </span><span class="s1">e</span>

    <span class="s3">if </span><span class="s1">jax_unimpl:</span>
      <span class="s1">logging.warning(</span><span class="s4">&quot;Found no JAX error but expected JAX limitations: %s in &quot;</span>
                      <span class="s4">&quot;harness: %s&quot;</span><span class="s3">,</span>
                      <span class="s1">[u.description </span><span class="s3">for </span><span class="s1">u </span><span class="s3">in </span><span class="s1">jax_unimpl]</span><span class="s3">, </span><span class="s1">harness.fullname)</span>
      <span class="s0"># We do not fail the test if we have too many limitations. If you want</span>
      <span class="s0"># to find extraneous limitations, uncomment this assert and run the test</span>
      <span class="s0"># on all platforms.</span>
      <span class="s0"># self.assertEmpty((&quot;Found no JAX error but expected JAX limitations: &quot;</span>
      <span class="s0">#                  f&quot;{[u.description for u in jax_unimpl]} in harness: {harness.fullname}&quot;))</span>

  <span class="s3">def </span><span class="s1">test_generate_primitives_coverage_doc(self):</span>
    <span class="s1">harnesses = primitive_harness.all_harnesses</span>
    <span class="s1">print(</span><span class="s4">f&quot;Found </span><span class="s3">{</span><span class="s1">len(harnesses)</span><span class="s3">} </span><span class="s4">harnesses&quot;</span><span class="s1">)</span>

    <span class="s1">harness_groups: Dict[str</span><span class="s3">, </span><span class="s1">Sequence[primitive_harness.Harness]] = collections.defaultdict(list)</span>

    <span class="s3">def </span><span class="s1">unique_hash(h: primitive_harness.Harness</span><span class="s3">, </span><span class="s1">l: primitive_harness.Limitation):</span>
      <span class="s3">return </span><span class="s1">(h.group_name</span><span class="s3">, </span><span class="s1">l.description</span><span class="s3">, </span><span class="s1">l.devices</span><span class="s3">,</span>
              <span class="s1">tuple(np.dtype(d).name </span><span class="s3">for </span><span class="s1">d </span><span class="s3">in </span><span class="s1">l.dtypes))</span>

    <span class="s1">unique_limitations: Dict[Any</span><span class="s3">, </span><span class="s1">Tuple[primitive_harness.Harness</span><span class="s3">,</span>
                                        <span class="s1">primitive_harness.Limitation]] = {}</span>

    <span class="s3">for </span><span class="s1">h </span><span class="s3">in </span><span class="s1">harnesses:</span>
      <span class="s1">harness_groups[h.group_name].append(h)</span>
      <span class="s3">for </span><span class="s1">l </span><span class="s3">in </span><span class="s1">h.jax_unimplemented:</span>
        <span class="s3">if </span><span class="s1">l.enabled:</span>
          <span class="s1">unique_limitations[hash(unique_hash(h</span><span class="s3">, </span><span class="s1">l))] = (h</span><span class="s3">, </span><span class="s1">l)</span>

    <span class="s1">primitive_coverage_table = [</span><span class="s4">&quot;&quot;&quot; 
| Primitive | Total test harnesses | dtypes supported on at least one device | dtypes NOT tested on any device | 
| --- | --- | --- | --- |&quot;&quot;&quot;</span><span class="s1">]</span>
    <span class="s1">all_dtypes = set(jtu.dtypes.all)</span>

    <span class="s3">for </span><span class="s1">group_name </span><span class="s3">in </span><span class="s1">sorted(harness_groups.keys()):</span>
      <span class="s1">hlist = harness_groups[group_name]</span>
      <span class="s1">dtypes_tested = set()  </span><span class="s0"># Tested on at least some device</span>
      <span class="s3">for </span><span class="s1">h </span><span class="s3">in </span><span class="s1">hlist:</span>
        <span class="s1">dtypes_tested = dtypes_tested.union({h.dtype})</span>

      <span class="s1">primitive_coverage_table.append(</span>
        <span class="s4">f&quot;| </span><span class="s3">{</span><span class="s1">group_name</span><span class="s3">} </span><span class="s4">| </span><span class="s3">{</span><span class="s1">len(hlist)</span><span class="s3">} </span><span class="s4">| &quot;</span>
        <span class="s4">f&quot;</span><span class="s3">{</span><span class="s1">primitive_harness.dtypes_to_str(dtypes_tested)</span><span class="s3">} </span><span class="s4">| &quot;</span>
        <span class="s4">f&quot;</span><span class="s3">{</span><span class="s1">primitive_harness.dtypes_to_str(all_dtypes - dtypes_tested)</span><span class="s3">} </span><span class="s4">|&quot;</span><span class="s1">)</span>

    <span class="s1">print(</span><span class="s4">f&quot;Found </span><span class="s3">{</span><span class="s1">len(unique_limitations)</span><span class="s3">} </span><span class="s4">unique limitations&quot;</span><span class="s1">)</span>
    <span class="s1">primitive_unimpl_table = [</span><span class="s4">&quot;&quot;&quot; 
| Affected primitive | Description of limitation | Affected dtypes | Affected devices | 
| --- | --- | --- | --- |&quot;&quot;&quot;</span><span class="s1">]</span>
    <span class="s3">for </span><span class="s1">h</span><span class="s3">, </span><span class="s1">l </span><span class="s3">in </span><span class="s1">sorted(</span>
        <span class="s1">unique_limitations.values()</span><span class="s3">, </span><span class="s1">key=</span><span class="s3">lambda </span><span class="s1">pair: unique_hash(*pair)):</span>
      <span class="s1">devices = </span><span class="s4">&quot;, &quot;</span><span class="s1">.join(l.devices)</span>
      <span class="s1">primitive_unimpl_table.append(</span>
        <span class="s4">f&quot;|</span><span class="s3">{</span><span class="s1">h.group_name</span><span class="s3">}</span><span class="s4">|</span><span class="s3">{</span><span class="s1">l.description</span><span class="s3">}</span><span class="s4">|&quot;</span>
        <span class="s4">f&quot;</span><span class="s3">{</span><span class="s1">primitive_harness.dtypes_to_str(l.dtypes</span><span class="s3">, </span><span class="s1">empty_means_all=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">}</span><span class="s4">|</span><span class="s3">{</span><span class="s1">devices</span><span class="s3">}</span><span class="s4">|&quot;</span><span class="s1">)</span>

    <span class="s3">if not </span><span class="s1">os.environ.get(</span><span class="s4">&quot;JAX_OUTPUT_LIMITATIONS_DOC&quot;</span><span class="s1">):</span>
      <span class="s3">raise </span><span class="s1">unittest.SkipTest(</span><span class="s4">&quot;Set JAX_OUTPUT_LIMITATIONS_DOC=1 to enable the generation of the documentation&quot;</span><span class="s1">)</span>
    <span class="s0"># The CPU/GPU have more supported types than TPU.</span>
    <span class="s1">self.assertEqual(</span><span class="s4">&quot;cpu&quot;</span><span class="s3">, </span><span class="s1">jtu.device_under_test()</span><span class="s3">, </span><span class="s4">&quot;The documentation can be generated only on CPU&quot;</span><span class="s1">)</span>
    <span class="s1">self.assertTrue(config.x64_enabled</span><span class="s3">, </span><span class="s4">&quot;The documentation must be generated with JAX_ENABLE_X64=1&quot;</span><span class="s1">)</span>

    <span class="s3">with </span><span class="s1">open(os.path.join(os.path.dirname(__file__)</span><span class="s3">,</span>
                           <span class="s4">'../g3doc/jax_primitives_coverage.md.template'</span><span class="s1">)) </span><span class="s3">as </span><span class="s1">f:</span>
      <span class="s1">template = f.read()</span>
    <span class="s1">output_file = os.path.join(os.path.dirname(__file__)</span><span class="s3">,</span>
                               <span class="s4">'../g3doc/jax_primitives_coverage.md'</span><span class="s1">)</span>

    <span class="s3">with </span><span class="s1">open(output_file</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
      <span class="s1">f.write(template.replace(</span><span class="s4">&quot;{{generation_date}}&quot;</span><span class="s3">, </span><span class="s1">str(datetime.date.today())) \</span>
              <span class="s1">.replace(</span><span class="s4">&quot;{{nr_harnesses}}&quot;</span><span class="s3">, </span><span class="s1">str(len(harnesses))) \</span>
              <span class="s1">.replace(</span><span class="s4">&quot;{{nr_primitives}}&quot;</span><span class="s3">, </span><span class="s1">str(len(harness_groups))) \</span>
              <span class="s1">.replace(</span><span class="s4">&quot;{{primitive_unimpl_table}}&quot;</span><span class="s3">, </span><span class="s4">&quot;</span><span class="s3">\n</span><span class="s4">&quot;</span><span class="s1">.join(primitive_unimpl_table)) \</span>
              <span class="s1">.replace(</span><span class="s4">&quot;{{primitive_coverage_table}}&quot;</span><span class="s3">, </span><span class="s4">&quot;</span><span class="s3">\n</span><span class="s4">&quot;</span><span class="s1">.join(primitive_coverage_table)))</span>


<span class="s3">if </span><span class="s1">__name__ == </span><span class="s4">&quot;__main__&quot;</span><span class="s1">:</span>
  <span class="s1">absltest.main(testLoader=jtu.JaxTestLoader())</span>
</pre>
</body>
</html>