<html>
<head>
<title>cross_compilation_check.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
cross_compilation_check.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright 2023 The JAX Authors.</span>
<span class="s0">#</span>
<span class="s0"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0"># you may not use this file except in compliance with the License.</span>
<span class="s0"># You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0"># Unless required by applicable law or agreed to in writing, software</span>
<span class="s0"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0"># See the License for the specific language governing permissions and</span>
<span class="s0"># limitations under the License.</span>

<span class="s2">r&quot;&quot;&quot;Tests for cross-lowering. 
 
We check that we produce the same exact HLO using native lowering and with 
cross-lowering. This will save the HLO for all PrimitiveHarnesses as generated 
on the current backend (`jax.default_backend()`) for all of `cpu`, `gpu`, and 
`tpu`. The file names are &lt;save_directory&gt;/&lt;harness_name&gt;/for_{cpu,tpu}_on_{cpu,tpu}.mlir. 
 
If a saved file already exists produced on a different backend, then compare the 
currently saved file with the saved one. 
 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">contextlib</span>
<span class="s3">import </span><span class="s1">dataclasses</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">re</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Callable</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">, </span><span class="s1">Sequence</span>
<span class="s3">import </span><span class="s1">zlib</span>

<span class="s3">from </span><span class="s1">absl </span><span class="s3">import </span><span class="s1">app</span>
<span class="s3">from </span><span class="s1">absl </span><span class="s3">import </span><span class="s1">logging</span>

<span class="s3">import </span><span class="s1">numpy.random </span><span class="s3">as </span><span class="s1">npr</span>

<span class="s3">import </span><span class="s1">jax</span>
<span class="s3">from </span><span class="s1">jax.config </span><span class="s3">import </span><span class="s1">config   </span><span class="s0"># Must import before TF</span>
<span class="s3">from </span><span class="s1">jax.experimental </span><span class="s3">import </span><span class="s1">jax2tf  </span><span class="s0"># Defines needed flags</span>
<span class="s3">from </span><span class="s1">jax._src </span><span class="s3">import </span><span class="s1">test_util  </span><span class="s0"># Defines needed flags</span>

<span class="s1">config.parse_flags_with_absl()</span>

<span class="s0"># Import after parsing flags</span>
<span class="s3">from </span><span class="s1">jax.experimental.jax2tf.tests </span><span class="s3">import </span><span class="s1">primitive_harness</span>

<span class="s1">@dataclasses.dataclass</span>
<span class="s3">class </span><span class="s1">Scenario:</span>
  <span class="s1">harness: primitive_harness.Harness</span>
  <span class="s1">on_platform: str</span>
  <span class="s1">for_platform: str</span>

  <span class="s1">@property</span>
  <span class="s3">def </span><span class="s1">short_name(self) -&gt; str:</span>
    <span class="s1">basename = re.sub(</span><span class="s4">r&quot;[^a-zA-Z0-9_\-]&quot;</span><span class="s3">, </span><span class="s4">&quot;_&quot;</span><span class="s3">, </span><span class="s1">self.harness.fullname)</span>
    <span class="s3">if </span><span class="s1">len(basename) &gt;= </span><span class="s5">128</span><span class="s1">:</span>
      <span class="s1">basename = basename[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">100</span><span class="s1">] + str(hash(self.harness.fullname))</span>
    <span class="s3">return </span><span class="s1">basename</span>

  <span class="s3">def </span><span class="s1">output_file(self</span><span class="s3">, </span><span class="s1">save_directory: str) -&gt; str:</span>
    <span class="s1">basename = self.short_name</span>
    <span class="s3">return </span><span class="s1">os.path.join(</span>
        <span class="s1">save_directory</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">,</span>
        <span class="s4">f&quot;for_</span><span class="s3">{</span><span class="s1">self.for_platform</span><span class="s3">}</span><span class="s4">_on_</span><span class="s3">{</span><span class="s1">self.on_platform</span><span class="s3">}</span><span class="s4">.mlir&quot;</span><span class="s1">)</span>

  <span class="s3">def </span><span class="s1">__str__(self):</span>
    <span class="s3">return </span><span class="s4">f&quot;Scenario(harness=</span><span class="s3">{</span><span class="s1">self.harness.fullname</span><span class="s3">}</span><span class="s4">, on=</span><span class="s3">{</span><span class="s1">self.on_platform</span><span class="s3">}</span><span class="s4">, for=</span><span class="s3">{</span><span class="s1">self.for_platform</span><span class="s3">}</span><span class="s4">, basename=</span><span class="s3">{</span><span class="s1">self.short_name</span><span class="s3">}</span><span class="s4">&quot;</span>

<span class="s3">class </span><span class="s1">Io:</span>
  <span class="s2">&quot;&quot;&quot;Abstracts a few IO operation over standard &quot;open&quot; vs. gfile.&quot;&quot;&quot;</span>
  <span class="s3">def </span><span class="s1">__init__(self</span><span class="s3">, </span><span class="s1">use_gfile=</span><span class="s3">False</span><span class="s1">):</span>
    <span class="s1">self.use_gfile = use_gfile</span>
    <span class="s3">if </span><span class="s1">use_gfile:</span>
      <span class="s3">from </span><span class="s1">tensorflow.io </span><span class="s3">import </span><span class="s1">gfile</span>
      <span class="s1">self.gfile = gfile</span>
    <span class="s3">else</span><span class="s1">:</span>
      <span class="s1">self.gfile = </span><span class="s3">None</span>

  <span class="s3">def </span><span class="s1">exists(self</span><span class="s3">, </span><span class="s1">filename: str) -&gt; bool:</span>
    <span class="s3">if </span><span class="s1">self.use_gfile:</span>
      <span class="s3">return </span><span class="s1">self.gfile.exists(filename)</span>
    <span class="s3">else</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s1">os.path.exists(filename)</span>

  <span class="s3">def </span><span class="s1">makedirs(self</span><span class="s3">, </span><span class="s1">dirname: str):</span>
    <span class="s3">if </span><span class="s1">self.use_gfile:</span>
      <span class="s3">return </span><span class="s1">self.gfile.makedirs(dirname)</span>
    <span class="s3">else</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s1">os.makedirs(dirname)</span>

  <span class="s1">@contextlib.contextmanager</span>
  <span class="s3">def </span><span class="s1">open(self</span><span class="s3">, </span><span class="s1">filename: str</span><span class="s3">, </span><span class="s1">mode: str):</span>
    <span class="s3">if </span><span class="s1">self.use_gfile:</span>
      <span class="s1">f = self.gfile.GFile(filename</span><span class="s3">, </span><span class="s1">mode=mode)</span>
    <span class="s3">else</span><span class="s1">:</span>
      <span class="s1">f = open(filename</span><span class="s3">, </span><span class="s1">mode=mode)</span>
    <span class="s3">try</span><span class="s1">:</span>
      <span class="s3">yield </span><span class="s1">f</span>
    <span class="s3">finally</span><span class="s1">:</span>
      <span class="s1">f.close()</span>


<span class="s3">def </span><span class="s1">write_and_check_harness(harness: primitive_harness.Harness</span><span class="s3">,</span>
                            <span class="s1">io: Io</span><span class="s3">,</span>
                            <span class="s1">save_directory: str</span><span class="s3">,</span>
                            <span class="s1">for_platforms: Sequence[str] = (</span><span class="s4">&quot;cpu&quot;</span><span class="s3">, </span><span class="s4">&quot;tpu&quot;</span><span class="s1">)</span><span class="s3">,</span><span class="s1">) -&gt; Sequence[str]:</span>
  <span class="s2">&quot;&quot;&quot;Writes and checks HLO for a given harness. 
 
  Writes the HLOs generated in the current platform for all platforms. 
  If it finds previously written HLOs generated on other platforms, compares 
  them with the ones generated on this platform. 
 
  Returns a list of harnesses on which diffs were found. 
  &quot;&quot;&quot;</span>
  <span class="s1">diffs = []</span>

  <span class="s1">func_jax = harness.dyn_fun</span>
  <span class="s1">rng = npr.RandomState(zlib.adler32(harness.fullname.encode()))</span>
  <span class="s1">args = harness.dyn_args_maker(rng)</span>

  <span class="s0"># Generate the HLO for all platforms</span>
  <span class="s3">for </span><span class="s1">for_platform </span><span class="s3">in </span><span class="s1">for_platforms:</span>
    <span class="s3">if not </span><span class="s1">harness.filter(for_platform):</span>
      <span class="s1">logging.info(</span><span class="s4">&quot;Skip harness %s for %s because it is not implemented in JAX&quot;</span><span class="s3">,</span>
                   <span class="s1">harness.fullname</span><span class="s3">, </span><span class="s1">for_platform)</span>
      <span class="s3">continue</span>

    <span class="s1">scenario1 = Scenario(harness</span><span class="s3">, </span><span class="s1">jax.default_backend()</span><span class="s3">, </span><span class="s1">for_platform)</span>
    <span class="s1">output_file = scenario1.output_file(save_directory)</span>
    <span class="s1">output_dir = os.path.dirname(output_file)</span>
    <span class="s3">if not </span><span class="s1">io.exists(output_dir):</span>
      <span class="s1">io.makedirs(output_dir)</span>

    <span class="s3">if </span><span class="s1">io.exists(output_file):</span>
      <span class="s3">with </span><span class="s1">io.open(output_file</span><span class="s3">, </span><span class="s4">&quot;r&quot;</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
        <span class="s1">hlo = f.read()</span>
    <span class="s3">else</span><span class="s1">:</span>
      <span class="s0"># For a tighter check, detect the native platform lowering and do not</span>
      <span class="s0"># trigger cross-lowering</span>
      <span class="s3">if </span><span class="s1">for_platform == jax.default_backend():</span>
        <span class="s1">lowered = jax.jit(func_jax).lower(*args)</span>
      <span class="s3">else</span><span class="s1">:</span>
        <span class="s0"># TODO: replace this with JAX cross-platform API, without going through</span>
        <span class="s0"># jax2tf</span>
        <span class="s3">from </span><span class="s1">jax.experimental.jax2tf.jax2tf </span><span class="s3">import </span><span class="s1">cross_platform_lowering</span>
        <span class="s1">lowered = cross_platform_lowering(func_jax</span><span class="s3">, </span><span class="s1">args</span><span class="s3">,</span>
                                          <span class="s1">platforms=[for_platform])</span>
      <span class="s1">hlo = lowered.compiler_ir(dialect=</span><span class="s4">&quot;stablehlo&quot;</span><span class="s1">)  </span><span class="s0"># type: ignore</span>
      <span class="s3">with </span><span class="s1">io.open(output_file</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
        <span class="s1">f.write(str(hlo))</span>

    <span class="s0"># Compare with previously written files</span>
    <span class="s3">for </span><span class="s1">on_platform </span><span class="s3">in </span><span class="s1">[</span><span class="s4">'cpu'</span><span class="s3">, </span><span class="s4">'tpu'</span><span class="s1">]:</span>
      <span class="s3">if </span><span class="s1">on_platform == jax.default_backend():</span>
        <span class="s3">continue</span>
      <span class="s1">scenario2 = Scenario(harness</span><span class="s3">, </span><span class="s1">on_platform</span><span class="s3">, </span><span class="s1">for_platform)</span>
      <span class="s1">other_file = scenario2.output_file(save_directory)</span>
      <span class="s3">if </span><span class="s1">io.exists(other_file):</span>
        <span class="s1">logging.info(</span><span class="s4">&quot;Comparing for %s harness %s on %s vs %s&quot;</span><span class="s3">,</span>
                     <span class="s1">for_platform</span><span class="s3">, </span><span class="s1">harness.fullname</span><span class="s3">, </span><span class="s1">jax.default_backend()</span><span class="s3">, </span><span class="s1">on_platform)</span>
        <span class="s3">with </span><span class="s1">io.open(other_file</span><span class="s3">, </span><span class="s4">&quot;r&quot;</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
          <span class="s1">other_hlo = f.read()</span>

        <span class="s3">if </span><span class="s1">hlo != other_hlo:</span>
          <span class="s1">logging.info(</span><span class="s4">&quot;Found diff&quot;</span><span class="s3">,</span>
                       <span class="s1">for_platform</span><span class="s3">, </span><span class="s1">harness.fullname</span><span class="s3">, </span><span class="s1">jax.default_backend()</span><span class="s3">, </span><span class="s1">on_platform)</span>
          <span class="s1">diffs.append(</span><span class="s4">f&quot;Found diff between </span><span class="s3">{</span><span class="s1">output_file</span><span class="s3">} </span><span class="s4">and </span><span class="s3">{</span><span class="s1">other_file</span><span class="s3">}</span><span class="s4">&quot;</span><span class="s1">)</span>

  <span class="s3">return </span><span class="s1">diffs</span>

<span class="s3">def </span><span class="s1">write_and_check_harnesses(io: Io</span><span class="s3">,</span>
                              <span class="s1">save_directory: str</span><span class="s3">,</span>
                              <span class="s1">*</span><span class="s3">,</span>
                              <span class="s1">filter_harness: Optional[Callable[[str]</span><span class="s3">, </span><span class="s1">bool]] = </span><span class="s3">None,</span>
                              <span class="s1">for_platforms: Sequence[str] = (</span><span class="s4">&quot;cpu&quot;</span><span class="s3">, </span><span class="s4">&quot;tpu&quot;</span><span class="s1">)</span><span class="s3">,</span>
                              <span class="s1">verbose = </span><span class="s3">False</span><span class="s1">):</span>
  <span class="s1">logging.info(</span><span class="s4">&quot;Writing and checking harnesses at %s&quot;</span><span class="s3">, </span><span class="s1">save_directory)</span>
  <span class="s1">nr_harnesses = len(primitive_harness.all_harnesses)</span>
  <span class="s3">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">harness </span><span class="s3">in </span><span class="s1">enumerate(primitive_harness.all_harnesses):</span>
    <span class="s3">if </span><span class="s1">i % </span><span class="s5">100 </span><span class="s1">== </span><span class="s5">0</span><span class="s1">:</span>
      <span class="s1">logging.info(</span><span class="s4">&quot;Trying cross-lowering for harness #%d/%d&quot;</span><span class="s3">,</span>
                   <span class="s1">i</span><span class="s3">, </span><span class="s1">nr_harnesses)</span>
    <span class="s1">enable_xla = harness.params.get(</span><span class="s4">&quot;enable_xla&quot;</span><span class="s3">, True</span><span class="s1">)</span>
    <span class="s3">if not </span><span class="s1">enable_xla:</span>
      <span class="s3">if </span><span class="s1">verbose:</span>
        <span class="s1">logging.info(</span><span class="s4">&quot;Skip %s due to enable_xla=False&quot;</span><span class="s3">, </span><span class="s1">harness.fullname)</span>
      <span class="s3">continue</span>

    <span class="s3">if </span><span class="s1">filter_harness </span><span class="s3">is not None and not </span><span class="s1">filter_harness(harness.fullname):</span>
      <span class="s3">if </span><span class="s1">verbose:</span>
        <span class="s1">logging.info(</span><span class="s4">&quot;Skip %s due to filter_harness&quot;</span><span class="s3">, </span><span class="s1">harness.fullname)</span>
      <span class="s3">continue</span>

    <span class="s1">write_and_check_harness(harness</span><span class="s3">, </span><span class="s1">io</span><span class="s3">, </span><span class="s1">save_directory</span><span class="s3">,</span>
                            <span class="s1">for_platforms=for_platforms)</span>


<span class="s3">def </span><span class="s1">main(argv: Sequence[str]) -&gt; </span><span class="s3">None</span><span class="s1">:</span>
  <span class="s3">if </span><span class="s1">len(argv) &gt; </span><span class="s5">1</span><span class="s1">:</span>
    <span class="s3">raise </span><span class="s1">app.UsageError(</span><span class="s4">&quot;Too many command-line arguments.&quot;</span><span class="s1">)</span>
  <span class="s3">def </span><span class="s1">filter_harness(name: str) -&gt; bool:</span>
    <span class="s3">return </span><span class="s4">&quot;cummax&quot; </span><span class="s3">in </span><span class="s1">name</span>
  <span class="s1">for_platforms = (</span><span class="s4">'cpu'</span><span class="s3">, </span><span class="s4">'tpu'</span><span class="s1">)</span>
  <span class="s1">write_and_check_harnesses(Io(</span><span class="s3">False</span><span class="s1">)</span><span class="s3">, </span><span class="s4">&quot;./hlo_dumps&quot;</span><span class="s3">,</span>
                            <span class="s1">filter_harness=filter_harness</span><span class="s3">,</span>
                            <span class="s1">for_platforms=for_platforms)</span>


<span class="s3">if </span><span class="s1">__name__ == </span><span class="s4">&quot;__main__&quot;</span><span class="s1">:</span>
  <span class="s1">app.run(main)</span>
</pre>
</body>
</html>